<!DOCTYPE html>
<html lang="en">
  <head>
    {% load staticfiles %}
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Movie GEEKs</title>

    <!-- Bootstrap -->
    <link href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css" rel="stylesheet">


    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <script src="{% static 'js/collector.js' %}"></script>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://dimplejs.org/dist/dimple.v2.2.0.min.js"></script>
              <script>
            function get_url(movieid) {
              return 'https://api.themoviedb.org/3/find/tt' + movieid + '?external_source=imdb_id&api_key={{ api_key }}'
            }

            function get_sim_users(this_user, type) {
            min_overlap = 4
            url = '/rec/sim/user/' + this_user + '/' + type + '/?min=' + min_overlap
                $.getJSON(url,
                          function(result) {

                            ul =  document.getElementById('sim_users_' + type)
                            if (result.similarity != null &&
                                Object.keys(result.similarity).length > 0) {
                                for (var key in result.similarity)
                                {
                                  if (result.similarity.hasOwnProperty(key)) {
                                    li = document.createElement('li')
                                    a = document.createElement('a')
                                    a.setAttribute('href', '/analytics/user/' + result.similarity[key][0])

                                    sim = parseFloat(result.similarity[key][1])
                                    a.innerHTML = result.similarity[key][0] + ':' + sim
                                    li.appendChild(a)
                                    ul.appendChild(li)
                                  }
                                }
                             } else {
                                    li = document.createElement('li')
                                    li.innerHTML = 'No similar users found, with min = ' + min_overlap
                                    ul.appendChild(li)
                             }
                          });
          }

          function get_association_rule_recs(userid) {
            url = '/rec/ar/' + userid + '/'

            $.getJSON(url,
                function(result) {
                    if ((result.data != null) && (result.data.length > 0)) {


                        result.data.forEach(function(element, index, array) {

                            $.getJSON(get_url(element.id), function(result) {
                                image_url = 'http://image.tmdb.org/t/p/w500/'
                                + result.movie_results[0].poster_path

                                rec_div = document.createElement('div')
                                rec_div.setAttribute('class', "col-sm-2 img-responsive")

                                a = document.createElement('a')
                                a.setAttribute('href', '/movies/movie/' + element.id)

                                img = document.createElement('img')
                                img.setAttribute('src', image_url)
                                img.setAttribute('class',"img-responsive")

                                a.appendChild(img)

                                rec_div.appendChild(a)

                                recs = document.getElementById('association_rule_recs')

                                recs.appendChild(rec_div)

                            })

                        });
                    }

                });
        }

        function get_cb_recs(userid) {
            url = '/rec/cb/user/' + userid + '/'

            $.getJSON(url,
                function(result) {
                    if ((result.data != null) && (result.data.length > 0)) {
                        recs = document.getElementById('cb_recs')


                        result.data.forEach(function(element, index, array) {

                            $.getJSON(get_url(element.target), function(mov) {
                                image_url = 'http://image.tmdb.org/t/p/w500/'
                                + mov.movie_results[0].poster_path

                                rec_div = document.createElement('div')
                                rec_div.setAttribute('class', "col-sm-2 img-responsive")

                                a = document.createElement('a')
                                a.setAttribute('href', '/movies/movie/' + element.target)

                                img = document.createElement('img')
                                img.setAttribute('src', image_url)
                                img.setAttribute('class',"img-responsive")
                                a.appendChild(img)

                                rec_div.appendChild(a)
                                recs = document.getElementById('cb_recs')
                                recs.appendChild(rec_div)

                            })

                        });
                    }

                });
        }


        function get_cf_recs(userid) {
            url = '/rec/cf/user/' + userid + '/'

            $.getJSON(url,
                function(result) {
                    if ((result.data != null) && (result.data.length > 0)) {


                        result.data.forEach(function(element, index, array) {

                            $.getJSON(get_url(element[0]), function(mov) {
                                image_url = 'http://image.tmdb.org/t/p/w500/'
                                + mov.movie_results[0].poster_path

                                rec_div = document.createElement('div')
                                rec_div.setAttribute('class', "col-sm-2 img-responsive")

                                a = document.createElement('a')
                                a.setAttribute('href', '/analytics/content/' + element[0])

                                img = document.createElement('img')
                                img.setAttribute('src', image_url)
                                img.setAttribute('class',"img-responsive")
                                img.setAttribute('title', element[1].sim_items)
                                a.appendChild(img)

                                rec_div.appendChild(a)

                                recs = document.getElementById('cf_recs')
                                recs.appendChild(rec_div)

                            })

                        });
                    }

                });
        }


    </script>
    <title>User</title>
</head>
<body>
<div class='container'>
  <div class='row'>
    <h1>User Profile id: {{ user_id }} (in cluster: <a href="/analytics/cluster/{{cluster}}">{{ cluster }}</a>)</h1>

    <div>
      Average rating: {{ avg_rating }} / 10
    </div>

  </div>
  <div class='row'>
    <div class="col-sm-3 well">
    <h2>Movie rated</h2>
    <ul>
    {% for movie in movies %}
        <li><a href="/analytics/content/{{ movie.movie_id }}">{{ movie.title }}</a> {{ movie.rating }}/10 </li>
    {% endfor %}
    </ul>
  </div>
  <div class="col-sm-9 well">
    <h2>Taste</h2>
  <div id="chartContainer">

    <script type="text/javascript">
      var svg = dimple.newSvg("#chartContainer", 700, 400);
      var data = [
        {% for key, value in genres.items %}
          { "name": '{{key}}', "value": {{value}} },
        {% endfor %}
      ];
      var chart = new dimple.chart(svg, data);
      chart.setBounds(50, 10, 600, 300);

      x = chart.addCategoryAxis("x", "name");
      y = chart.addMeasureAxis("y", "value");
      chart.addSeries(null, dimple.plot.bar);
      x.addOrderRule("name")
      chart.draw();
    </script>
  </div>
  </div>
  </div>
  <h2>Personalised recommendations</h2>
    <div class="row">
        <div class="col-sm-1">
          Association rules:
        </div>
        <div class="col-sm-11">
          <div id="association_rule_recs"></div>
        </div>
    </div>
    <div class="row well" styles="height: 150px">
        <div class="col-sm-1">
          Content-based recs:
        </div>
        <div class="col-sm-11">
          <div id="cb_recs"></div>
        </div>
    </div>
    <div class="row">
          <div class="col-sm-1">
           Collaborative-based recs:
          </div>
          <div class="col-sm-11">
            <div id="cf_recs"></div>
          </div>
    </div>
  </div>
  <div class="row">
      <div class="col-sm-3">
        <h2>Similar users</h2>
        <div class="row">
            <div class="col-sm-6">
                <strong>Jaccard sim</strong>
                <ul id="sim_users_jaccard" >

                </ul>
                  <script>
                  get_sim_users({{user_id}}, 'jaccard')
                </script>
            </div>
            <div class="col-sm-6">
                <strong>Pearson sim</strong>
                <ul id="sim_users_pearson"></ul>
              <script>
                  get_sim_users({{user_id}}, 'pearson')
              </script>
            </div>
        </div>
    </div>
  </div>

  <div class="row">
    <h2>Recent Log</h2>

    {% for row in logs %}
      <a href="/analytics/content/{{ row.content_id }}"/>{{row.content_id}}</a> | {{ row.event }} | {{ row.created }} <br />
    {% endfor %}
  </div>
</div>
<script type="text/javascript">
        get_association_rule_recs({{user_id}})
        get_cb_recs({{user_id}})
        get_cf_recs({{user_id}})
    </script>
</body>
</html>